# Makefile para comandos da TORRE

# Caminhos (relativos ao diretÃ³rio atual)
CHECKPOINTS_DIR := checkpoints
LOGS_DIR := logs
REPORTS_DIR := reports
RELATORIOS_DIR := ../relatorios

.PHONY: torre_report torre_checkpoint torre_status torre_train torre_eval torre_list_checkpoints torre_list_logs torre_clean_logs torre_validate_dataset torre_help

# Gera relatÃ³rio tÃ©cnico de treino
torre_report:
	@echo "ðŸ“Š Gerando relatÃ³rio tÃ©cnico da TORRE..."
	@python3 cli/generate_report.py
	@echo "âœ… RelatÃ³rio gerado em $(REPORTS_DIR)/train_summary.md"

# Cria checkpoint do estado atual
torre_checkpoint:
	@echo "ðŸ’¾ Criando checkpoint..."
	@python3 cli/create_checkpoint.py
	@echo "âœ… Checkpoint criado em $(CHECKPOINTS_DIR)/"

# Atualiza status da TORRE
torre_status:
	@echo "ðŸ“‹ Atualizando status da TORRE..."
	@python3 cli/update_status.py
	@echo "âœ… Status atualizado em $(RELATORIOS_DIR)/torre_status.json"

# Executa treino de uma fase
torre_train:
	@echo "ðŸš€ Executando treino..."
	@echo "Uso: make torre_train PHASE=N [DATASET=path] [EPOCHS=N]"
	@if [ -z "$(PHASE)" ]; then \
		echo "âŒ ERRO: Especifique PHASE (0-5)"; \
		exit 1; \
	fi
	@python3 cli/train.py --phase $(PHASE) \
		$$([ -n "$(DATASET)" ] && echo --dataset $(DATASET)) \
		$$([ -n "$(EPOCHS)" ] && echo --epochs $(EPOCHS))
	@echo "âœ… Treino concluÃ­do"

# Avalia checkpoint
torre_eval:
	@echo "ðŸ” Avaliando checkpoint..."
	@echo "Uso: make torre_eval CHECKPOINT=path [DATASET=path]"
	@if [ -z "$(CHECKPOINT)" ]; then \
		echo "âŒ ERRO: Especifique CHECKPOINT"; \
		exit 1; \
	fi
	@python3 cli/eval.py --checkpoint $(CHECKPOINT) \
		$$([ -n "$(DATASET)" ] && echo --dataset $(DATASET))
	@echo "âœ… AvaliaÃ§Ã£o concluÃ­da"

# Lista checkpoints disponÃ­veis
torre_list_checkpoints:
	@echo "ðŸ“¦ Checkpoints disponÃ­veis:"
	@ls -lh $(CHECKPOINTS_DIR)/*.ckpt 2>/dev/null || echo "Nenhum checkpoint encontrado"

# Lista logs disponÃ­veis
torre_list_logs:
	@echo "ðŸ“ Logs disponÃ­veis:"
	@ls -lh $(LOGS_DIR)/*.log 2>/dev/null || echo "Nenhum log encontrado"

# Limpa logs antigos (mantÃ©m Ãºltimos 30 dias)
torre_clean_logs:
	@echo "ðŸ§¹ Limpando logs antigos (>30 dias)..."
	@find $(LOGS_DIR) -name "*.log" -mtime +30 -delete 2>/dev/null || true
	@echo "âœ… Limpeza concluÃ­da"

# Valida conformidade constitucional dos datasets
torre_validate_dataset:
	@echo "ðŸ”’ Validando dataset..."
	@echo "Uso: make torre_validate_dataset DATASET=path"
	@if [ -z "$(DATASET)" ]; then \
		echo "âŒ ERRO: Especifique DATASET"; \
		exit 1; \
	fi
	@python3 cli/validate_dataset.py --dataset $(DATASET)
	@echo "âœ… ValidaÃ§Ã£o concluÃ­da"

# Help
torre_help:
	@echo "ðŸ“š Comandos disponÃ­veis da TORRE:"
	@echo ""
	@echo "  make torre_report              - Gera relatÃ³rio tÃ©cnico (train_summary.md)"
	@echo "  make torre_checkpoint          - Cria checkpoint do estado atual"
	@echo "  make torre_status              - Atualiza status em relatorios/torre_status.json"
	@echo "  make torre_train PHASE=N       - Executa treino da fase N (0-5)"
	@echo "  make torre_eval CHECKPOINT=... - Avalia checkpoint"
	@echo "  make torre_list_checkpoints    - Lista checkpoints disponÃ­veis"
	@echo "  make torre_list_logs           - Lista logs disponÃ­veis"
	@echo "  make torre_clean_logs          - Limpa logs antigos (>30 dias)"
	@echo "  make torre_validate_dataset DATASET=... - Valida dataset"
	@echo ""
	@echo "ðŸ“– Ver curriculum/PLAN.md para detalhes do plano de treino"
