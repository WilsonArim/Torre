from typing import Tuple, Dict
import re

DECL_HEADER = "// AUTO-GENERATED by Fortaleza LLM â€” ambient types\n"

ASSET_DECLS = [
    "declare module '*.css';",
    "declare module '*.module.css';",
    "declare module '*.scss';",
    "declare module '*.module.scss';",
    "declare module '*.svg' { const src: string; export default src; }",
    "declare module '*.png' { const src: string; export default src; }",
    "declare module '*.jpg' { const src: string; export default src; }",
    "declare module '*.jpeg' { const src: string; export default src; }",
    "declare module '*.gif' { const src: string; export default src; }",
    "declare module '*.webp' { const src: string; export default src; }",
    "declare module '*.json' { const value: any; export default value; }",
]

JSX_DECL = [
    "declare namespace JSX { interface IntrinsicElements { [elemName: string]: any } }"
]

NODE_DECL = [
    "declare const process: any;",
    "declare const Buffer: any;",
]

TESTS_VITEST = [
    "declare const describe: any;", "declare const it: any;", "declare const test: any;",
    "declare const expect: any;", "declare const vi: any;",
]
TESTS_JEST = [
    "declare const describe: any;", "declare const it: any;", "declare const test: any;",
    "declare const expect: any;", "declare const jest: any;",
]

def _ambient_path(files: Dict[str, str]) -> str:
    has_src = any(str(p).startswith("src/") or "/src/" in str(p) for p in files.keys())
    base = "src" if has_src else "."
    return f"{base}/types/ambient.d.ts"

def _ensure_lines(blob: str, lines: list[str]) -> tuple[str, bool]:
    changed = False
    out = blob if blob else (DECL_HEADER + "\n")
    for ln in lines:
        if not re.search(re.escape(ln), out):
            if not out.endswith("\n"):
                out += "\n"
            out += ln + "\n"
            changed = True
    return out, changed

def ensure_ambient_kit(files: Dict[str, str], kit: str) -> tuple[str, Dict[str, str], bool]:
    """
    kits: 'assets' | 'jsx' | 'node' | 'tests-vitest' | 'tests-jest'
    """
    path = _ambient_path(files)
    content = files.get(path, "")
    lines: list[str] = []
    if kit == "assets":
        lines = ASSET_DECLS
    elif kit == "jsx":
        lines = JSX_DECL
    elif kit == "node":
        lines = NODE_DECL
    elif kit == "tests-vitest":
        lines = TESTS_VITEST
    elif kit == "tests-jest":
        lines = TESTS_JEST
    else:
        return path, files, False
    new_blob, changed = _ensure_lines(content, lines)
    if changed:
        files[path] = new_blob
    return path, files, changed
