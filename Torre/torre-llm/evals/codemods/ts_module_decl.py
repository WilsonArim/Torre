from typing import Dict

DECL_HEADER = "// AUTO-GENERATED by Fortaleza LLM — ambient module declarations\n"

def ensure_module_decl(files: Dict[str, str], module_id: str) -> tuple[str, Dict[str, str], bool]:
    """
    Garante declaração de módulo idempotente.
    Retorna (path, files, changed).
    """
    # procura arquivo de declarações existente
    decl_path = None
    for path in files.keys():
        if path.endswith("ambient.d.ts") or path.endswith("types.d.ts"):
            decl_path = path
            break
    
    # se não existir, cria em src/types/ambient.d.ts
    if not decl_path:
        decl_path = "src/types/ambient.d.ts"
    
    content = files.get(decl_path, DECL_HEADER)
    
    # verifica se já existe declaração
    if f"declare module '{module_id}';" in content:
        return decl_path, files, False
    
    # acrescenta declaração simples (idempotente)
    if not content.endswith("\n"):
        content += "\n"
    content += f"declare module '{module_id}';\n"
    files[decl_path] = content
    return decl_path, files, True
