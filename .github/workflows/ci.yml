name: Factory CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Precisamos de pelo menos 2 commits para comparar
      - name: üîí Validate Constitution immutability
        run: |
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "core/sop/constitui√ß√£o.yaml"; then
            echo "‚ö†Ô∏è ERRO CR√çTICO: Tentativa de modifica√ß√£o da Constitui√ß√£o detectada!"
            echo "A Constitui√ß√£o da F√ÅBRICA √© imut√°vel e n√£o pode ser alterada."
            echo "Nenhum agente, humano ou LLM pode modificar core/sop/constitui√ß√£o.yaml"
            exit 1
          fi
          echo "‚úÖ Constitui√ß√£o intacta (imut√°vel)"
      - name: ‚ùå Block legacy pipeline scripts
        run: |
          if git diff --name-only HEAD~1 | grep -E '^ordem/|^deprecated/ordem/'; then
            echo "Uso/modifica√ß√£o de scripts legados de pipeline √© proibido."; exit 1; fi
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Pre-commit
        run: |
          pip install pre-commit
          make -C core/orquestrador precommit || true
      - name: Security and SBOM
        run: |
          pip install bandit coverage
          npm --version || true
          make -C core/orquestrador security sbom || true
      - name: SOP validation
        run: |
          python3 core/scripts/validator.py
      - name: üõ°Ô∏è Run Gatekeeper (Composer Edition)
        run: make -C core/orquestrador gatekeeper_run
      - name: üìÑ Upload Gatekeeper report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gatekeeper-report
          path: relatorios/parecer_gatekeeper.md
      - name: Gatekeeper prep (pipeline audit)
        run: |
          make -C core/orquestrador gatekeeper_prep
      - name: Fail if pipeline invalid
        run: |
          jq -e '.pipeline_ok == true' relatorios/pipeline_gate_input.json
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: relatorios
          path: relatorios


