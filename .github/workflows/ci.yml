name: Factory CI

on:
  push:
    branches: [main, master]
  pull_request:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Precisamos de pelo menos 2 commits para comparar
      - name: ðŸ”’ Validate Constitution immutability
        run: |
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "core/sop/constituiÃ§Ã£o.yaml"; then
            echo "âš ï¸ ERRO CRÃTICO: Tentativa de modificaÃ§Ã£o da ConstituiÃ§Ã£o detectada!"
            echo "A ConstituiÃ§Ã£o da FÃBRICA Ã© imutÃ¡vel e nÃ£o pode ser alterada."
            echo "Nenhum agente, humano ou LLM pode modificar core/sop/constituiÃ§Ã£o.yaml"
            exit 1
          fi
          echo "âœ… ConstituiÃ§Ã£o intacta (imutÃ¡vel)"
      - name: âŒ Block legacy pipeline scripts
        run: |
          if git diff --name-only HEAD~1 | grep -E '^ordem/|^deprecated/ordem/'; then
            echo "Uso/modificaÃ§Ã£o de scripts legados de pipeline Ã© proibido."; exit 1; fi
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Pre-commit
        run: |
          pip install pre-commit
          make -C core/orquestrador precommit || true
      - name: Security and SBOM
        run: |
          pip install bandit coverage
          npm --version || true
          make -C core/orquestrador security sbom || true
      - name: SOP validation
        run: |
          if [ ! -f "core/scripts/validator.py" ]; then
            echo "ERRO CRÃTICO: core/scripts/validator.py nÃ£o encontrado" >&2
            exit 1
          fi
          python3 core/scripts/validator.py || {
            echo "ERRO: SOP validation falhou" >&2
            exit 1
          }
      - name: ðŸ›¡ï¸ Run Gatekeeper (Composer Edition)
        continue-on-error: false
        run: |
          make -C core/orquestrador gatekeeper_run || {
            echo "ERRO CRÃTICO: Gatekeeper falhou" >&2
            echo "Verifique logs em relatorios/parecer_gatekeeper.md" >&2
            exit 1
          }
      - name: ðŸ“„ Upload Gatekeeper report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gatekeeper-report
          path: relatorios/parecer_gatekeeper.md
      - name: Gatekeeper prep (pipeline audit)
        run: |
          make -C core/orquestrador gatekeeper_prep
      - name: Fail if pipeline invalid
        run: |
          jq -e '.pipeline_ok == true' relatorios/pipeline_gate_input.json
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: relatorios
          path: relatorios
