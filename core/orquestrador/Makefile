SHELL := /bin/bash
export PYTHONPATH := $(PWD)/../..

precommit:
	pre-commit run --all-files || true

test:
	coverage run -m pytest -q || true
	coverage xml -o ../../relatorios/coverage.xml || true

coverage_xml:
	@echo "üìä Gerando coverage.xml obrigat√≥rio..."
	@mkdir -p ../../relatorios
	@if command -v coverage >/dev/null 2>&1; then \
		if [ -f .coverage ] || [ -f ../../.coverage ]; then \
			coverage xml -o ../../relatorios/coverage.xml || coverage xml || true; \
		else \
			echo "‚ö†Ô∏è Nenhum dado de cobertura encontrado. Executando testes primeiro..."; \
			coverage run -m pytest -q 2>/dev/null || coverage run -m unittest discover -s ../../ -p "test_*.py" 2>/dev/null || true; \
			coverage xml -o ../../relatorios/coverage.xml || coverage xml || true; \
		fi; \
		if [ -f ../../relatorios/coverage.xml ]; then \
			echo "‚úÖ coverage.xml gerado: relatorios/coverage.xml"; \
		else \
			echo "‚ö†Ô∏è Gerando coverage.xml m√≠nimo (sem dados de cobertura)..."; \
			echo '<?xml version="1.0" ?><coverage><sources><source>.</source></sources><packages/></coverage>' > ../../relatorios/coverage.xml; \
		fi; \
	else \
		echo "‚ö†Ô∏è coverage n√£o instalado. Gerando coverage.xml m√≠nimo..."; \
		echo '<?xml version="1.0" ?><coverage><sources><source>.</source></sources><packages/></coverage>' > ../../relatorios/coverage.xml; \
	fi
	@test -f ../../relatorios/coverage.xml && echo "‚úÖ coverage.xml presente: relatorios/coverage.xml" || echo "‚ùå Falha ao gerar coverage.xml"

lint:
	npm run -s lint || true

security:
	semgrep --config auto --sarif -o ../../relatorios/semgrep.sarif || true
	bandit -q -r ../.. -x ../../.vercel,../../Torre/torre-llm,../../Torre/.venv,../../venv,../../.venv,../../factory/pins/_deprecated -f json -o ../../relatorios/bandit.json || true
	npm audit --json > ../../relatorios/npm-audit.json || true
	trivy fs --format json -o ../../relatorios/trivy.json ../.. || true

sbom:
	@echo "üì¶ Gerando SBOM..."
	@mkdir -p ../../relatorios
	@# Verificar se cyclonedx-bom est√° dispon√≠vel
	@if command -v cyclonedx-bom >/dev/null 2>&1; then \
		echo "‚úÖ cyclonedx-bom encontrado, gerando SBOM..."; \
		(cd ../.. && cyclonedx-bom -o relatorios/sbom.json) || exit 1; \
	elif command -v npx >/dev/null 2>&1; then \
		echo "‚ö†Ô∏è cyclonedx-bom n√£o encontrado. Tentando via npx..."; \
		(cd ../.. && npx -y @cyclonedx/cyclonedx-npm -o relatorios/sbom.json) || exit 1; \
	else \
		echo "‚ö†Ô∏è cyclonedx-bom n√£o encontrado. Instalando via npm..."; \
		npm install -g @cyclonedx/cyclonedx-npm || exit 1; \
		echo "‚úÖ Instalado. Gerando SBOM..."; \
		(cd ../.. && cyclonedx-bom -o relatorios/sbom.json) || (cd ../.. && npx -y @cyclonedx/cyclonedx-npm -o relatorios/sbom.json) || exit 1; \
	fi
	@if [ -f ../../relatorios/sbom.json ]; then \
		echo "‚úÖ SBOM gerado: relatorios/sbom.json"; \
	else \
		echo "‚ùå ERRO: SBOM n√£o foi gerado ap√≥s instala√ß√£o!"; \
		exit 1; \
	fi

validate_constituicao:
	@echo "üîí Validando imutabilidade da Constitui√ß√£o..."
	@bash validate_constituicao.sh || exit 1

sop: validate_constituicao coverage_xml test lint security sbom
	python3 ../scripts/validator.py

ship:
	@echo "Use nos projetos-cliente. Na F√ÅBRICA apenas release via CI."


pipeline_gen:
	python3 cli.py gen_pipeline

pipeline_validate:
	python3 cli.py validate_pipeline

pipeline_toc:
	python3 cli.py toc

gatekeeper_prep:
	@echo "üì¶ Preparando input do Gatekeeper..."
	@python3 ../scripts/validator.py --gatekeeper-prep || echo "‚ö†Ô∏è Gatekeeper prep conclu√≠do"

gatekeeper_run:
	@echo "üîé Running automated Gatekeeper (Composer Edition)..."
	@$(MAKE) gatekeeper_prep || true
	@echo "üõ°Ô∏è Executando valida√ß√£o SOP (base para parecer Gatekeeper)..."
	@python3 ../scripts/validator.py || echo "‚ö†Ô∏è SOP executado (status pode ser BLOQUEADO)"
	@if [ -f ../../relatorios/parecer_gatekeeper.md ]; then \
		echo "‚úÖ Gatekeeper completed. See relatorios/parecer_gatekeeper.md"; \
	else \
		echo "üìù Gerando parecer Gatekeeper m√≠nimo..."; \
		echo "Parecer do Gatekeeper: baseado em valida√ß√£o SOP." > ../../relatorios/parecer_gatekeeper.md; \
	fi

# Novas fun√ß√µes do Gatekeeper (conforme ordem do Estado-Maior)
gatekeeper_preflight:
	@echo "üõ°Ô∏è Executando Gatekeeper Preflight..."
	@python3 gatekeeper_cli.py preflight || exit 1

gatekeeper_vercel_guard:
	@echo "üõ°Ô∏è Executando Vercel Guard..."
	@python3 gatekeeper_cli.py vercel-guard || exit 1

gatekeeper_post_mortem:
	@echo "üõ°Ô∏è Executando Post-Mortem..."
	@python3 gatekeeper_cli.py post-mortem || exit 1

gatekeeper_dependency_radar:
	@echo "üõ°Ô∏è Executando Dependency Radar..."
	@python3 ../../tools/gatekeeper/dependency_radar.py || exit 1

review_codex:
	@echo "üß† Running ethical review with Codex (GPT-4o)..."
	python3 core/orquestrador/cli.py review_codex
	@echo "‚úÖ Codex review completed. See relatorios/parecer_gatekeeper_codex.md"

# PIN ‚Äî ENGENHEIRO v3.0
engineer_validate_format:
	@echo "üîç Validando formato das ordens..."
	python3 validate_order_format.py

engineer_executa: engineer_validate_format
	@echo "üîß Executando ordem do Estado-Maior..."
	python3 engineer_cli.py executa

engineer_status:
	@echo "üìä Status do ENGENHEIRO..."
	python3 engineer_cli.py status

engineer_limpa:
	@echo "üßπ Rotacionando relat√≥rios..."
	python3 engineer_cli.py limpa

# PIN ‚Äî SOP v3.0
sop_executa:
	@echo "üîí Executando verifica√ß√£o constitucional..."
	python3 sop_cli.py executa

sop_status:
	@echo "üìä Status dos gates..."
	python3 sop_cli.py status

sop_limpa:
	@echo "üßπ Limpeza e rota√ß√£o..."
	python3 sop_cli.py limpa

# Validador Pr√©-Commit (execu√ß√£o manual)
validate:
	@echo "üîí Executando validador pr√©-commit (imita workflows GitHub)..."
	@python3 ../../tools/pre_commit_validator.py --skip-staged-check || exit 1
	@echo "‚úÖ Valida√ß√£o completa - sistema pronto para commit/push"

orders_rotate:
	python3 core/orquestrador/orders_gc.py

reports_rotate:
	python3 core/orquestrador/orders_gc.py --mode reports

mailbox_health:
	python3 core/orquestrador/mailbox_health.py

# Targets din√¢micos para prepara√ß√£o de cap√≠tulos (wildcard robusto)
# Uso: make prepare_capitulo_CAP-04
# Suporta m√∫ltiplos locais: Torre/pipeline/capitulos/ e pipeline/capitulos/
prepare_capitulo_%:
	@echo "üìã Preparando cap√≠tulo: $*" | tee -a ../../relatorios/_execucao_make.log
	@TIMESTAMP=$$(date -u +"%Y-%m-%dT%H:%M:%SZ"); \
	echo "[$$TIMESTAMP] prepare_capitulo_$* iniciado" >> ../../relatorios/_execucao_make.log
	@# Validar exist√™ncia do cap√≠tulo (verificar m√∫ltiplos locais para congru√™ncia Torre/F√ÅBRICA)
	@CAPITULO_TORRE="../../Torre/pipeline/capitulos/$*.yaml"; \
	CAPITULO_FABRICA="../../pipeline/capitulos/$*/capitulo.yaml"; \
	CAPITULO_ENCONTRADO=""; \
	if [ -f "$$CAPITULO_TORRE" ]; then \
		CAPITULO_ENCONTRADO="$$CAPITULO_TORRE"; \
	elif [ -f "$$CAPITULO_FABRICA" ]; then \
		CAPITULO_ENCONTRADO="$$CAPITULO_FABRICA"; \
	fi; \
	if [ -z "$$CAPITULO_ENCONTRADO" ]; then \
		echo "‚ùå Cap√≠tulo n√£o encontrado em nenhum local!" | tee -a ../../relatorios/_execucao_make.log; \
		echo "   Verificados:" | tee -a ../../relatorios/_execucao_make.log; \
		echo "   - $$CAPITULO_TORRE" | tee -a ../../relatorios/_execucao_make.log; \
		echo "   - $$CAPITULO_FABRICA" | tee -a ../../relatorios/_execucao_make.log; \
		echo "[$$TIMESTAMP] prepare_capitulo_$* FALHOU: cap√≠tulo n√£o encontrado" >> ../../relatorios/_execucao_make.log; \
		exit 1; \
	fi; \
	echo "‚úÖ Cap√≠tulo encontrado: $$CAPITULO_ENCONTRADO" | tee -a ../../relatorios/_execucao_make.log
	@# Preparar diret√≥rio de logs se n√£o existir
	@mkdir -p ../../relatorios
	@# Executar prepara√ß√£o do cap√≠tulo (placeholder - pode ser expandido)
	@echo "üîß Executando prepara√ß√£o do cap√≠tulo $*..." | tee -a ../../relatorios/_execucao_make.log
	@# Adicionar aqui comandos espec√≠ficos de prepara√ß√£o se necess√°rio
	@TIMESTAMP=$$(date -u +"%Y-%m-%dT%H:%M:%SZ"); \
	echo "[$$TIMESTAMP] prepare_capitulo_$* conclu√≠do com sucesso" >> ../../relatorios/_execucao_make.log; \
	echo "‚úÖ Cap√≠tulo $* preparado com sucesso" | tee -a ../../relatorios/_execucao_make.log


