versao: 1
titulo: "DOUTRINA DE ACESSO A FICHEIROS"
descricao: >
  Doutrina imutável de acesso a ficheiros. Não pode ser violada nunca.
  Não pode ser ambígua nem ter dualidade de critérios.
  Esta doutrina define as permissões e restrições de acesso a ficheiros
  para cada agente da FÁBRICA, garantindo que cada agente apenas pode
  modificar ficheiros dentro da sua jurisdição.
prioridade: "MÁXIMA"
imutavel: true
data_criacao: "2025-11-02"
assinatura: "Estado-Maior da FÁBRICA"
auditoria: "SOP v3.0"
hierarquia:
  nivel: 3
  superior_a: ["leis.yaml"]
  inferior_a: ["constituição.yaml"]
  explicacao: >
    A doutrina está abaixo da Constituição e acima das Leis.
    Nenhuma lei pode violar esta doutrina.
    Nenhuma ação pode violar esta doutrina.

acesso_ficheiros:
  engenheiro:
    ler: ["*"]
    escrever: ["*"]
    requisito: "APENAS com ordem do Estado-Maior em ordem/ordens/engineer.in.yaml"
    explicacao: >
      O Engenheiro pode ler e escrever qualquer ficheiro, mas APENAS quando
      existe uma ordem válida do Estado-Maior com ACK=ACCEPTED.
      Sem ordem válida, nenhuma escrita é permitida.
  
  estado_maior:
    ler: ["*"]
    escrever:
      - "relatorios/**/*.md"
      - "relatorios/**/*.yaml"
      - "relatorios/**/*.json"
      - "ordem/ordens/*.in.yaml"
    proibido:
      - "**/*.py"
      - "**/*.js"
      - "**/*.ts"
      - "**/*.go"
      - "**/*.rs"
      - "**/*.java"
      - "**/*.cpp"
      - "**/*.c"
      - "core/**"  # Exceto relatórios
      - "pipeline/**"  # Exceto relatórios
      - "factory/pins/*.yaml"  # PINs são imutáveis pelo Estado-Maior
    explicacao: >
      O Estado-Maior pode ler qualquer ficheiro, mas apenas pode criar/editar/eliminar
      relatórios (markdown, yaml, json) e ordens (mailbox).
      Qualquer modificação de código-fonte ou configurações deve ser feita pelo Engenheiro.
  
  sop:
    ler: ["*"]
    escrever:
      - "relatorios/**/*.md"
      - "relatorios/para_estado_maior/**"
    proibido:
      - "**/*.py"  # Exceto relatorios/para_estado_maior/
      - "**/*.js"
      - "**/*.ts"
      - "**/*.go"
      - "**/*.rs"
      - "**/*.java"
      - "**/*.cpp"
      - "**/*.c"
      - "core/**"  # Exceto relatórios
      - "pipeline/**"  # Exceto relatórios
    explicacao: >
      O SOP pode ler qualquer ficheiro, mas apenas pode criar/editar/eliminar
      relatórios markdown e qualquer ficheiro dentro de relatorios/para_estado_maior/.
  
  gatekeeper:
    ler: ["*"]
    escrever:
      - "relatorios/**/*.md"
      - "relatorios/para_estado_maior/**"
    proibido:
      - "**/*.py"  # Exceto relatorios/para_estado_maior/
      - "**/*.js"
      - "**/*.ts"
      - "**/*.go"
      - "**/*.rs"
      - "**/*.java"
      - "**/*.cpp"
      - "**/*.c"
      - "core/**"  # Exceto relatórios
      - "pipeline/**"  # Exceto relatórios
    explicacao: >
      O Gatekeeper pode ler qualquer ficheiro, mas apenas pode criar/editar/eliminar
      relatórios markdown e qualquer ficheiro dentro de relatorios/para_estado_maior/.

formato_interacoes:
  obrigatorio: true
  aplicavel_a: "TODAS as interações de TODOS os agentes com o Estado-Maior/usuário"
  inclui_agentes_torre: true
  inicio: "**PIPELINE/FORA_PIPELINE:** PIPELINE ou FORA_PIPELINE"
  fim: "**COMANDO A EXECUTAR:** \"AGENTE AÇÃO (localização)\""
  explicacao: >
    TODAS as interações de TODOS os agentes (incluindo agentes da Torre) devem:
    1. Começar com identificação PIPELINE/FORA_PIPELINE
    2. Terminar com comando explícito a executar
    
    Isso aplica-se a:
    - Relatórios em markdown
    - Respostas de texto dos agentes
    - Comunicações dos agentes
    - Qualquer interação entre agente e Estado-Maior/usuário
    
    Não é apenas para relatórios salvos em ficheiros, mas sim para TODAS as interações.
  exemplos:
    - "ESTADO-MAIOR ANALISAR RELATÓRIO (relatorios/para_estado_maior/sop.out.json)"
    - "ENGENHEIRO LÊ E EXECUTA ordem/ordens/engineer.in.yaml"
    - "SOP FAZ AUDITORIA"
    - "GATEKEEPER EXECUTA GATEKEEPER"

guardas_tecnicas:
  obrigatorio: true
  arquivo: "core/orquestrador/file_access_guard.py"
  funcao: "validar_permissao_escrita(agente: str, caminho: Path) -> tuple[bool, str]"
  explicacao: >
    Todas as operações de escrita devem ser validadas através desta função.
    Se a validação falhar, a escrita deve ser bloqueada e um erro crítico reportado.

violacoes:
  tratamento: "BLOQUEIO IMEDIATO"
  log: "relatorios/violacoes_acesso_ficheiros.log"
  explicacao: >
    Qualquer violação desta doutrina deve resultar em bloqueio imediato da operação
    e registo da violação no log de violações.

